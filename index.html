<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>خريطة ذهنية من إجابات نموذج جوجل</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f7f7f7;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        
        p {
            text-align: center;
            margin-bottom: 20px;
            color: #555;
        }
        
        .mind-map {
            width: 100%;
            height: 500px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .node circle {
            fill: #fff;
            stroke: #3498db;
            stroke-width: 2px;
        }
        
        .node text {
            font-size: 12px;
            text-anchor: middle;
        }
        
        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5px;
        }
        
        .node-main circle {
            fill: #3498db;
            stroke: #2980b9;
        }
        
        .node-main text {
            fill: white;
            font-weight: bold;
        }
        
        .node-sub circle {
            fill: #f1c40f;
            stroke: #f39c12;
        }
        
        .options {
            text-align: center;
            margin: 20px 0;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button#editBtn {
            background-color: #e74c3c;
        }
        
        button#editBtn:hover {
            background-color: #c0392b;
        }
        
        button#downloadBtn {
            background-color: #27ae60;
        }
        
        button#downloadBtn:hover {
            background-color: #2ecc71;
        }
        
        .hidden {
            display: none;
        }
        
        .instructions {
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 5px 5px 0;
        }
        
        .instructions h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        .instructions code {
            background-color: #f1f1f1;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: Consolas, monospace;
        }
        
        .setup-guide {
            border-top: 1px solid #eee;
            margin-top: 40px;
            padding-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media print {
            .no-print {
                display: none;
            }
            
            .container {
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>خريطة ذهنية من إجابات نموذج جوجل</h1>
        
        <div id="loadingSection" class="loading">
            <p>جاري استخراج بياناتك من النموذج...</p>
            <div class="loading-spinner"></div>
        </div>
        
        <div id="errorSection" class="hidden">
            <p style="color: #e74c3c;">لم نتمكن من العثور على بيانات النموذج. يرجى التأكد من الرابط والإعدادات.</p>
        </div>
        
        <div id="mainSection" class="hidden">
            <p>تم إنشاء خريطتك الذهنية بناءً على إجاباتك في نموذج جوجل. راجعها قبل التسليم النهائي.</p>
            
            <div id="mindMap" class="mind-map"></div>
            
            <div class="options no-print">
                <button id="editBtn" onclick="goBackToForm()">العودة للنموذج وتعديل الإجابات</button>
                <button id="submitBtn" onclick="submitFinal()">تأكيد وتسليم النموذج</button>
                <button id="downloadBtn" onclick="downloadMindMap()">تحميل الخريطة الذهنية</button>
                <button id="printBtn" onclick="window.print()">طباعة الخريطة الذهنية</button>
            </div>
        </div>
        
        <div id="setupGuide" class="setup-guide no-print">
            <div class="instructions">
                <h3>إرشادات للربط مع نموذج جوجل:</h3>
                <ol>
                    <li>في إعدادات نموذج جوجل، انتقل إلى التبويب "إرسال".</li>
                    <li>حدد "صفحة تأكيد" ثم "صفحة ويب مخصصة".</li>
                    <li>أضف رابط هذه الصفحة مع معلمات URL للأسئلة، مثال:<br>
                    <code>https://your-website.com/mind-map.html?mainTopic=ENTRY_123456&topic1=ENTRY_234567&topic1Details=ENTRY_345678</code></li>
                    <li>استبدل <code>ENTRY_XXXXX</code> بمعرفات أسئلة النموذج، والتي يمكنك الحصول عليها من عنوان التنسيق المسبق.</li>
                    <li>تأكد من أن نموذجك يحتوي على الحقول التالية على الأقل:
                        <ul>
                            <li>سؤال للموضوع الرئيسي</li>
                            <li>أسئلة للمواضيع الفرعية (3 على الأقل)</li>
                            <li>أسئلة لتفاصيل كل موضوع فرعي (اختياري)</li>
                        </ul>
                    </li>
                </ol>
            </div>
        </div>
    </div>
    
    <script>
        // الرابط الأصلي للنموذج (يمكن استبداله بمتغير من URL)
        let formURL = '';
        let formSubmitted = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            // إخفاء قسم التحميل بعد تأخير
            setTimeout(() => {
                // حاول استخراج البيانات من معلمات URL
                try {
                    const params = new URLSearchParams(window.location.search);
                    const formData = extractFormDataFromURL(params);
                    
                    // حفظ عنوان النموذج الأصلي إذا كان موجودًا
                    if (params.has('formURL')) {
                        formURL = decodeURIComponent(params.get('formURL'));
                    }
                    
                    if (formData.mainTopic) {
                        // لدينا بيانات، اعرض الخريطة الذهنية
                        renderMindMap(formData);
                        document.getElementById('loadingSection').classList.add('hidden');
                        document.getElementById('mainSection').classList.remove('hidden');
                    } else {
                        // لا توجد بيانات كافية
                        document.getElementById('loadingSection').classList.add('hidden');
                        document.getElementById('errorSection').classList.remove('hidden');
                        document.getElementById('setupGuide').classList.remove('hidden');
                    }
                } catch (error) {
                    console.error('Error parsing URL parameters:', error);
                    document.getElementById('loadingSection').classList.add('hidden');
                    document.getElementById('errorSection').classList.remove('hidden');
                    document.getElementById('setupGuide').classList.remove('hidden');
                }
            }, 1000);
        });
        
        // استخراج بيانات النموذج من معلمات URL
        function extractFormDataFromURL(params) {
            const data = {
                mainTopic: params.get('mainTopic') || '',
                topics: []
            };
            
            // استخراج المواضيع الفرعية والتفاصيل
            for (let i = 1; i <= 5; i++) {
                const topicKey = `topic${i}`;
                const detailsKey = `topic${i}Details`;
                
                if (params.has(topicKey) && params.get(topicKey)) {
                    data.topics.push({
                        title: params.get(topicKey) || '',
                        details: params.has(detailsKey) ? params.get(detailsKey) || '' : ''
                    });
                }
            }
            
            return data;
        }
        
        // رسم الخريطة الذهنية باستخدام D3.js
        function renderMindMap(formData) {
            // تحضير البيانات بالتنسيق المطلوب لـ D3
            const data = {
                name: formData.mainTopic,
                children: formData.topics
                    .filter(topic => topic.title) // استبعاد المواضيع الفارغة
                    .map(topic => ({
                        name: topic.title,
                        details: topic.details,
                        children: topic.details
                            ? topic.details.split('\n')
                                .filter(line => line.trim())
                                .map(line => ({ name: line.trim() }))
                            : []
                    }))
            };
            
            // إزالة الرسم السابق إن وجد
            d3.select("#mindMap").selectAll("*").remove();
            
            // إعداد أبعاد الرسم
            const container = document.getElementById('mindMap');
            const width = container.clientWidth;
            const height = container.clientHeight;
            const radius = Math.min(width, height) / 2 - 50;
            
            // إنشاء SVG
            const svg = d3.select("#mindMap")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("id", "mindMapSVG")
                .append("g")
                .attr("transform", `translate(${width / 2},${height / 2})`);
            
            // إنشاء تخطيط شجري دائري
            const tree = d3.tree()
                .size([2 * Math.PI, radius])
                .separation((a, b) => (a.parent === b.parent ? 1 : 2) / a.depth);
            
            // إعداد التسلسل الهرمي
            const root = d3.hierarchy(data);
            tree(root);
            
            // إنشاء الروابط بين العقد
            svg.selectAll(".link")
                .data(root.links())
                .enter()
                .append("path")
                .attr("class", "link")
                .attr("d", d3.linkRadial()
                    .angle(d => d.x)
                    .radius(d => d.y));
            
            // إنشاء العقد
            const node = svg.selectAll(".node")
                .data(root.descendants())
                .enter()
                .append("g")
                .attr("class", d => {
                    if (d.depth === 0) return "node node-main";
                    if (d.depth === 1) return "node node-sub";
                    return "node";
                })
                .attr("transform", d => `translate(${radialPoint(d.x, d.y)})`);
            
            // إضافة دوائر للعقد
            node.append("circle")
                .attr("r", d => d.depth === 0 ? 40 : d.depth === 1 ? 30 : 20);
            
            // إضافة نص للعقد
            node.append("text")
                .attr("dy", ".31em")
                .text(d => {
                    // اختصار النص إذا كان طويلاً
                    const text = d.data.name;
                    if (text.length > 15) {
                        return text.substring(0, 12) + "...";
                    }
                    return text;
                })
                .attr("text-anchor", "middle")
                .style("font-size", d => d.depth === 0 ? "14px" : "12px");
            
            // وظيفة مساعدة لتحويل الإحداثيات القطبية إلى ديكارتية
            function radialPoint(x, y) {
                return [(y = +y) * Math.cos(x -= Math.PI / 2), y * Math.sin(x)];
            }
        }
        
        // الرجوع إلى النموذج للتعديل
        function goBackToForm() {
            if (formURL) {
                window.location.href = formURL;
            } else {
                alert('عذراً، لا يمكن العودة إلى النموذج الأصلي. الرجاء استخدام زر الرجوع في المتصفح.');
            }
        }
        
        // تأكيد وتسليم النموذج
        function submitFinal() {
            if (formSubmitted) {
                alert('تم تسليم النموذج بالفعل!');
                return;
            }
            
            // يمكنك هنا إضافة رمز لإرسال تأكيد إلى خادم أو قاعدة بيانات
            alert('تم تأكيد وتسليم النموذج بنجاح! تم حفظ الخريطة الذهنية الخاصة بك.');
            formSubmitted = true;
            
            // تعطيل زر التعديل بعد التسليم
            document.getElementById('editBtn').disabled = true;
            document.getElementById('submitBtn').disabled = true;
        }
        
        // تحميل الخريطة الذهنية كصورة SVG
        function downloadMindMap() {
            const svgElement = document.getElementById('mindMapSVG');
            if (!svgElement) {
                alert('لا يمكن تحميل الخريطة الذهنية في الوقت الحالي.');
                return;
            }
            
            // تحويل SVG إلى URL بيانات
            const svgData = new XMLSerializer().serializeToString(svgElement);
            const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
            const svgUrl = URL.createObjectURL(svgBlob);
            
            // إنشاء رابط التحميل
            const downloadLink = document.createElement('a');
            downloadLink.href = svgUrl;
            downloadLink.download = 'mind_map.svg';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            // تحرير URL البيانات
            setTimeout(() => {
                URL.revokeObjectURL(svgUrl);
            }, 100);
        }

        // إضافة دعم للنموذج المخصص لاختبار الصفحة
        function setupTestForm() {
            const setupGuide = document.getElementById('setupGuide');
            const testForm = document.createElement('div');
            testForm.innerHTML = `
                <div class="instructions">
                    <h3>اختبار الخريطة الذهنية:</h3>
                    <p>يمكنك تجربة الخريطة الذهنية مع بيانات اختبارية:</p>
                    <button onclick="loadTestData()">تحميل بيانات اختبارية</button>
                </div>
            `;
            setupGuide.appendChild(testForm);
        }

        // تحميل بيانات اختبارية للعرض
        function loadTestData() {
            const testData = {
                mainTopic: 'الموضوع الرئيسي للاختبار',
                topics: [
                    { title: 'الموضوع الفرعي الأول', details: 'تفاصيل الموضوع الأول\nنقطة إضافية' },
                    { title: 'الموضوع الفرعي الثاني', details: 'تفاصيل الموضوع الثاني' },
                    { title: 'الموضوع الفرعي الثالث', details: 'نقطة 1\nنقطة 2\nنقطة 3' }
                ]
            };
            
            renderMindMap(testData);
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('errorSection').classList.add('hidden');
            document.getElementById('mainSection').classList.remove('hidden');
        }

        // إضافة وظيفة الاختبار إذا لم يتم تمرير بيانات
        if (window.location.search === '') {
            setTimeout(() => {
                setupTestForm();
            }, 1500);
        }
    </script>
</body>
</html>
